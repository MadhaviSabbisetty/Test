import React, { useState } from "react";
import {
  Avatar,
  Badge,
  Box,
  IconButton,
  Toolbar,
  Typography,
  useTheme,
  useMediaQuery,
  CircularProgress,
} from "@mui/material";
import { Notifications, Menu as MenuIcon } from "@mui/icons-material";
import { useSelector } from "react-redux";
import { userAvatarCreator } from "../utils/userUtilities";
import NotificationDrawer from "./NotificationDrawer";
import ProfileDrawer from "./ProfileDrawer";
import SearchBar from "./search/SearchBar";
import fLogo from "../assets/Logos/Fincore_transperent.svg";
import useNotifications from "../hooks/useNotifications";
import NotificationPopup from "./NotificationPopup";
import AutorenewIcon from "@mui/icons-material/Autorenew";
import TaskProgressDrawer from "./TaskProgressDrawer";

const LayoutHeader = ({ drawerWidth, navigateToPage, handleDrawerToggle }) => {
  const [notificationDrawerOpen, setNotificationDrawerOpen] = useState(false);
  const [profileDrawerOpen, setProfileDrawerOpen] = useState(false);
  const [taskDrawerOpen, setTaskDrawerOpen] = useState(false);

  const {
    notifications,
    markAsRead,
    markAllAsRead,
    loadMore,
    hasMore,
    unreadCount,
    popNotification,
    setPopNotification,
    tasks,
    activeCount,
  } = useNotifications();

  const user = useSelector((state) => state.auth.user);
  const theme = useTheme();
  const isSmallScreen = useMediaQuery(theme.breakpoints.down("lg"));

  return (
    <Box
      position="fixed"
      sx={{
        width: { xs: "100%", lg: `calc(100% - ${drawerWidth}px)` },
        right: 0,
        top: 0,
        zIndex: 1200,
        background:
          "linear-gradient(90deg, rgba(162,141,240,0.3), rgba(93,63,211,0.8))",
      }}
    >
      <Toolbar sx={{ display: "flex", justifyContent: "space-between" }}>
        {/* Left side section */}
        <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
          {isSmallScreen && (
            <IconButton
              onClick={handleDrawerToggle}
              sx={{ color: "text.primary" }}
            >
              <MenuIcon />
            </IconButton>
          )}

          {isSmallScreen && (
            <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
              <img src={fLogo} alt="Logo" style={{ width: 40, height: 40 }} />
              <Typography variant="h6" sx={{ fontWeight: 700 }}>
                FinCore
              </Typography>
            </Box>
          )}
        </Box>

        {/* Right side section */}
        <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
          <SearchBar navigateToPage={navigateToPage} />

          {activeCount > 0 && (
            <IconButton onClick={() => setTaskDrawerOpen(true)}>
              <Badge badgeContent={activeCount} color="warning">
                <Box sx={{ position: "relative" }}>
                  <AutorenewIcon
                    sx={{ animation: "spin 1.2s linear infinite" }}
                  />
                  <CircularProgress
                    size={36}
                    sx={{
                      position: "absolute",
                      top: -6,
                      left: -6,
                      zIndex: -1,
                    }}
                  />
                </Box>
              </Badge>

              <style>
                {`@keyframes spin { 100% { transform: rotate(360deg); } }`}
              </style>
            </IconButton>
          )}
          <IconButton
            color="inherit"
            onClick={() => setNotificationDrawerOpen(true)}
          >
            {unreadCount > 0 ? (
              <Badge badgeContent={unreadCount || ""} color="error">
                <Notifications />
              </Badge>
            ) : (
              <Notifications />
            )}
          </IconButton>

          <Avatar
            onClick={() => setProfileDrawerOpen(true)}
            sx={{
              width: 32,
              height: 32,
              color: "primary.contrastText",
              backgroundColor: "primary.main",
              cursor: "pointer",
              ml: 1,
            }}
          >
            {userAvatarCreator(user)}
          </Avatar>
        </Box>
      </Toolbar>

      {taskDrawerOpen && (
        <TaskProgressDrawer
          open={taskDrawerOpen}
          onClose={() => setTaskDrawerOpen(false)}
          tasks={tasks}
        />
      )}

      <NotificationDrawer
        notificationDrawerOpen={notificationDrawerOpen}
        setNotificationDrawerOpen={setNotificationDrawerOpen}
        notifications={notifications}
        markAsRead={markAsRead}
        markAllAsRead={markAllAsRead}
        loadMore={loadMore}
        hasMore={hasMore}
      />

      <ProfileDrawer
        profileDrawerOpen={profileDrawerOpen}
        setProfileDrawerOpen={setProfileDrawerOpen}
      />

      {popNotification && (
        <NotificationPopup
          popup={popNotification}
          handleNotificationClick={() => {
            setNotificationDrawerOpen(true);
            setPopNotification(null);
          }}
          onClose={() => {
            setPopNotification(null);
          }}
        />
      )}
    </Box>
  );
};

export default React.memo(LayoutHeader);
