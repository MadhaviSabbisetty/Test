const startDownload = async ({
  callApi,
  url,
  payload,
  onSuccess,
  onNoData,
  onError,
}) => {
  try {
    setIsDownloading(true);
    setDownloadedBytes(0);

    const response = await callApi(
      url,
      payload,
      "POST",
      "blob",
      "application/json",
      {
        onDownloadProgress: (e) => {
          if (e?.loaded) setDownloadedBytes(e.loaded);
        },
      },
      false
    );

    // ðŸš« NO DATA CASE
    if (!response.data || response.data.size <= 22) {
      onNoData?.();
      return;
    }

    const disposition =
      response.headers["content-disposition"] ||
      response.headers["Content-Disposition"];

    let filename = "report.zip";
    if (disposition) {
      const match = disposition.match(/filename="(.+?)"/);
      if (match) filename = match[1];
    }

    const blobUrl = window.URL.createObjectURL(response.data);
    const a = document.createElement("a");
    a.href = blobUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(blobUrl);

    // âœ… SUCCESS
    onSuccess?.(filename);

  } catch (error) {
    if (error instanceof Blob) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const errorJson = JSON.parse(reader.result);
          onError?.(errorJson.message);
        } catch {
          onError?.("Something went wrong, kindly try again.");
        }
      };
      reader.readAsText(error);
    } else {
      onError?.("Network Error: Could not connect to server");
    }
  } finally {
    setIsDownloading(false);
    setDownloadedBytes(0);
  }
};







const handleFetchReportData = () => {
  if (!selectedReport || !selectedDate || dateError) return;

  startDownload({
    callApi,
    url: "/RS/reports/download",
    payload: {
      moduleType,
      fileName: selectedReport.fileName,
      date: selectedDate.format("YYYY-MM-DD"),
      roleId: user.role,
    },
    onSuccess: (filename) => {
      showSnackBar(
        `Report "${filename}" downloaded successfully`,
        "success"
      );
    },
    onNoData: () => {
      showSnackBar(
        "No reports found matching your current filter criteria",
        "warning"
      );
    },
    onError: (message) => {
      showSnackBar(
        message || "Something went wrong, kindly try again.",
        "error"
      );
    },
  });
};










const validateReport = async () => {
  try {
    const res = await callApi(
      "/RS/api/reports/validate",
      {
        moduleType,
        fileName: selectedReport.fileName,
        date: selectedDate.format("YYYY-MM-DD"),
        roleId: user.role,
      },
      "POST"
    );

    return res?.data?.valid === true;
  } catch (e) {
    showSnackBar(
      "Something went wrong. Please try again.",
      "error"
    );
    return false;
  }
};



const handleFetchReportData = async () => {
  if (!selectedReport || !selectedDate || dateError) return;

  const isValid = await validateReport();

  if (!isValid) {
    showSnackBar(
      "No reports found matching your criteria",
      "warning"
    );
    return;
  }

  showSnackBar(
    "Download started. You may continue working.",
    "info"
  );

  triggerBrowserDownload();
};


const triggerBrowserDownload = () => {
  const form = document.createElement("form");
  form.method = "POST";
  form.action = "/RS/api/reports/download";

  const payload = {
    moduleType,
    fileName: selectedReport.fileName,
    date: selectedDate.format("YYYY-MM-DD"),
    roleId: user.role,
  };

  Object.entries(payload).forEach(([key, value]) => {
    const input = document.createElement("input");
    input.type = "hidden";
    input.name = key;
    input.value = value;
    form.appendChild(input);
  });

  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
};
