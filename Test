<Autocomplete
  value={branch}
  options={branchList}
  loading={branchLoading}
  disabled={!circle}
  getOptionLabel={(o) => `${o.branchCode} - ${o.branchName}`}
  onChange={(e, v) => setBranch(v)}
  ListboxProps={{
    onScroll: (event) => {
      const listboxNode = event.currentTarget;
      const isBottom =
        listboxNode.scrollTop + listboxNode.clientHeight >=
        listboxNode.scrollHeight - 1;

      if (isBottom && branchHasMore && !branchLoading) {
        fetchBranches(circle, branchPage + 1); // ðŸ”¥ load next page
      }
    },
  }}
  renderInput={(params) => (
    <TextField
      {...params}
      label="Select Branch"
      InputProps={{
        ...params.InputProps,
        endAdornment: (
          <>
            {branchLoading && <CircularProgress size={20} />}
            {params.InputProps.endAdornment}
          </>
        ),
      }}
    />
  )}
/>


const fetchBranches = async (circle, page = 0) => {
  if (!circle?.circleCode || branchLoading || !branchHasMore) return;

  try {
    setBranchLoading(true);

    const res = await callApi(
      "/CM/common-master/indian-foreign-branches",
      {
        circleCode: circle.circleCode,
        page,
        size: 20,
      },
      "GET"
    );

    // ðŸ”¥ SAFELY extract array
    const newBranches = Array.isArray(res?.data?.content)
      ? res.data.content
      : Array.isArray(res?.data)
      ? res.data
      : [];

    setBranchList((prev) =>
      page === 0 ? newBranches : [...prev, ...newBranches]
    );

    // pagination flags
    setBranchHasMore(
      res?.data?.last !== undefined ? !res.data.last : newBranches.length === 20
    );

    setBranchPage(page);
  } catch {
    // do NOT break UI
  } finally {
    setBranchLoading(false);
  }
};
