
import { useEffect, useState } from "react";
import {
  Box,
  Card,
  Stack,
  RadioGroup,
  FormControlLabel,
  Radio,
  TextField,
  Button,
} from "@mui/material";
import Autocomplete from "@mui/material/Autocomplete";
import { LocalizationProvider, DatePicker } from "@mui/x-date-pickers";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import dayjs from "dayjs";
import useApi from "../../hooks/useApi";
import useCustomSnackbar from "../../utils/useCustomSnackbar";

export default function BranchWiseReports() {
  const { callApi } = useApi();
  const showSnackBar = useCustomSnackbar();

  /* ---------------- RADIO ---------------- */
  const [countryType, setCountryType] = useState("INDIAN");

  /* ---------------- MASTER DATA ---------------- */
  const [zoneList, setZoneList] = useState([]);
  const [circleList, setCircleList] = useState([]);
  const [branchList, setBranchList] = useState([]);
  const [reportList, setReportList] = useState([]);

  /* ---------------- SELECTED VALUES ---------------- */
  const [zone, setZone] = useState(null);
  const [circle, setCircle] = useState(null);
  const [branch, setBranch] = useState(null);
  const [report, setReport] = useState(null);
  const [reportDate, setReportDate] = useState(null);

  const [isDownloading, setIsDownloading] = useState(false);

  /* ---------------- INITIAL LOAD ---------------- */
  useEffect(() => {
    fetchZones();
    fetchReports();
  }, []);

  useEffect(() => {
    if (zone?.zoneCode) {
      fetchCircles(zone);
    } else {
      setCircleList([]);
    }
  }, [zone, countryType]);

  /* ---------------- RADIO CHANGE ---------------- */
  const handleCountryChange = (e) => {
    const value = e.target.value;
    setCountryType(value);

    setZone(null);
    setCircle(null);
    setBranch(null);
    setCircleList([]);
    setBranchList([]);

    if (value === "FOREIGN") {
      setZone({ zoneCode: 4, zoneDesc: "Foreign Office" });
    }
  };

  /* ---------------- API CALLS ---------------- */

  const fetchZones = async () => {
    const res = await callApi("/CM/common-master/indian-zones", {}, "GET");
    setZoneList(res?.data || []);
  };

  const fetchCircles = async (zone) => {
    if (!zone?.zoneCode) {
      setCircleList([]);
      return;
    }
    try {
      const bankType =
        countryType === "FOREIGN" ? "Foreign Office" : "Indian";
      const res = await callApi(
        `/CM/common-master/indian-foreign-circles?bankType=${encodeURIComponent(
          bankType
        )}&zoneCode=${zone.zoneCode}`,
        null,
        "GET"
      );
      setCircleList(res?.data || []);
    } catch {
      setCircleList([]);
    }
  };

  const fetchBranches = async (circle) => {
    if (!circle?.circleCode) {
      setBranchList([]);
      return;
    }
    try {
      const res = await callApi(
        `/CM/common-master/indian-foreign-branches?circleCode=${circle.circleCode}`,
        null,
        "GET"
      );
      setBranchList(res?.data || []);
    } catch {
      setBranchList([]);
    }
  };

  const fetchReports = async () => {
    const res = await callApi("/RS/reports/types", {}, "POST");
    setReportList(res?.data || []);
  };

  /* ---------------- DOWNLOAD (FIXED) ---------------- */
  const handleDownload = async () => {
    if (!circle || !branch || !report || !reportDate) return;

    const payload = {
      countryType,
      zoneId: zone?.zoneCode || null,
      circleCode: circle?.circleCode || null,
      branchCode: branch?.branchCode || null,
      reportId: report?.fileName || null,
      reportDate: reportDate.format("YYYY-MM-DD"),
    };

    try {
      setIsDownloading(true);

      const response = await callApi(
        "/RS/reports/download",
        payload,
        "POST",
        "blob",
        "application/json",
        {},
        false
      );

      if (!response?.data || response.data.size <= 22) {
        showSnackBar("No reports found for selected criteria", "warning");
        return;
      }

      // Extract filename
      let filename = "report.zip";
      const contentDisposition =
        response.headers?.["content-disposition"] ||
        response.headers?.["Content-Disposition"];

      if (contentDisposition) {
        const match = contentDisposition.match(/filename="(.+?)"/);
        if (match?.[1]) filename = match[1];
      }

      // Trigger download
      const url = window.URL.createObjectURL(response.data);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);

      showSnackBar(`Report "${filename}" downloaded successfully`, "success");
    } catch (error) {
      if (error instanceof Blob) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const err = JSON.parse(reader.result);
            showSnackBar(err.message || "Download failed", "error");
          } catch {
            showSnackBar("Something went wrong while downloading", "error");
          }
        };
        reader.readAsText(error);
      } else {
        showSnackBar("Network error while downloading report", "error");
      }
    } finally {
      setIsDownloading(false);
    }
  };

  /* ---------------- UI ---------------- */
  return (
    <Box minHeight="80vh" display="flex" justifyContent="center" alignItems="center">
      <Card sx={{ p: 4, width: 580 }}>
        <Stack spacing={3}>
          <RadioGroup row value={countryType} onChange={handleCountryChange}>
            <FormControlLabel value="INDIAN" control={<Radio />} label="Indian" />
            <FormControlLabel value="FOREIGN" control={<Radio />} label="Foreign" />
          </RadioGroup>

          {countryType === "INDIAN" && (
            <Autocomplete
              value={zone}
              options={zoneList}
              getOptionLabel={(o) => o?.zoneDesc || ""}
              isOptionEqualToValue={(o, v) => o.zoneCode === v.zoneCode}
              onChange={(e, v) => {
                setZone(v);
                setCircle(null);
                setBranch(null);
                setCircleList([]);
                setBranchList([]);
                if (v) fetchCircles(v);
              }}
              renderInput={(params) => (
                <TextField {...params} label="Select a Zone" />
              )}
            />
          )}

          <Autocomplete
            value={circle}
            options={circleList}
            disabled={!zone?.zoneCode}
            getOptionLabel={(o) => `${o.circleCode}-${o.circleName}`}
            isOptionEqualToValue={(o, v) => o.circleCode === v.circleCode}
            onChange={(e, v) => {
              setCircle(v);
              setBranch(null);
              setBranchList([]);
              if (v) fetchBranches(v);
            }}
            renderInput={(params) => (
              <TextField {...params} label="Select a Circle" />
            )}
          />

          <Autocomplete
            value={branch}
            options={branchList}
            disabled={!circle}
            getOptionLabel={(o) => `${o.branchCode}-${o.branchName}`}
            isOptionEqualToValue={(o, v) => o.branchCode === v.branchCode}
            onChange={(e, v) => setBranch(v)}
            renderInput={(params) => (
              <TextField {...params} label="Select a Branch" />
            )}
          />

          {branch && (
            <>
              <Autocomplete
                value={report}
                options={reportList}
                getOptionLabel={(o) => o?.reportName || ""}
                isOptionEqualToValue={(o, v) => o.id === v.id}
                onChange={(e, v) => setReport(v)}
                renderInput={(params) => (
                  <TextField {...params} label="Select a report" />
                )}
              />

              <LocalizationProvider dateAdapter={AdapterDayjs}>
                <DatePicker
                  label="Select report date"
                  maxDate={dayjs()}
                  value={reportDate}
                  onChange={setReportDate}
                />
              </LocalizationProvider>
            </>
          )}

          <Button
            variant="contained"
            size="large"
            disabled={!circle || !branch || !report || !reportDate || isDownloading}
            onClick={handleDownload}
          >
            {isDownloading ? "Downloading..." : "Fetch & Download"}
          </Button>
        </Stack>
      </Card>
    </Box>
  );
}
