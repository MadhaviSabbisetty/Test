<Autocomplete
  open={branchOpen}
  onOpen={() => setBranchOpen(true)}
  onClose={() => setBranchOpen(false)}

  value={branch}
  options={
    branchHasMore
      ? [...branchList, SHOW_MORE_OPTION]
      : branchList
  }

  loading={branchLoading}
  disabled={!circle}

  getOptionLabel={(option) => {
    if (option.__type === "SHOW_MORE") return option.label;
    return `${option.branchCode} - ${option.branchName}`;
  }}

  isOptionEqualToValue={(o, v) => {
    if (!o || !v) return false;
    if (o.__type === "SHOW_MORE" || v.__type === "SHOW_MORE") return false;
    return o.branchCode === v.branchCode;
  }}

  onChange={(e, value) => {
    // ðŸš« Block default behavior
    e.preventDefault();

    if (!value) return;

    // ðŸ”½ SHOW MORE CLICK
    if (value.__type === "SHOW_MORE") {
      fetchBranches(circle, branchSize + 20);

      // âœ… KEEP DROPDOWN OPEN
      setTimeout(() => setBranchOpen(true), 0);
      return;
    }

    // âœ… Normal branch selection
    setBranch(value);
    setBranchOpen(false);
  }}

  renderOption={(props, option) => {
    if (option.__type === "SHOW_MORE") {
      return (
        <li
          {...props}
          style={{
            textAlign: "center",
            fontWeight: 600,
            color: "#1976d2",
            cursor: "pointer",
          }}
        >
          â¬‡ Show more branchesâ€¦
        </li>
      );
    }

    return (
      <li {...props}>
        {option.branchCode} - {option.branchName}
      </li>
    );
  }}

  renderInput={(params) => (
    <TextField
      {...params}
      label="Select Branch"
      InputProps={{
        ...params.InputProps,
        endAdornment: (
          <>
            {branchLoading && <CircularProgress size={20} />}
            {params.InputProps.endAdornment}
          </>
        ),
      }}
    />
  )}
/>
