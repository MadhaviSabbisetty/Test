import * as React from "react";
import PropTypes from "prop-types";
import Tab from "@mui/material/Tab";
import DataParametersTab1 from "./DataParametersTab";
import DataParametersRequestTab2 from "./DataParametersRequestTab";
import ConnectWithoutContactIcon from "@mui/icons-material/ConnectWithoutContact";
import PendingActionsIcon from "@mui/icons-material/PendingActions";

import {
  DataPMasterTabs,
  DataPTabContainer,
  DataPMastermainBox,
} from "./DataParametersStyle";
import { Box, Paper } from "@mui/material";

function CustomTabPanel(props) {
  const { children, value, index, ...other } = props;

  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`simple-tabpanel-${index}`}
      aria-labelledby={`simple-tab-${index}`}
      {...other}
    >
      {value === index && <DataPMastermainBox>{children}</DataPMastermainBox>}
    </div>
  );
}

CustomTabPanel.propTypes = {
  children: PropTypes.node,
  index: PropTypes.number.isRequired,
  value: PropTypes.number.isRequired,
};

function a11yProps(index) {
  return {
    id: `simple-tab-${index}`,
    "aria-controls": `simple-tabpanel-${index}`,
  };
}

export default function DataParametersmain() {
  const [value, setValue] = React.useState(0);

  const handleChange = (event, newValue) => {
    setValue(newValue);
  };

  return (
    <>
      <DataPTabContainer fullWidth={"true"}>
        <DataPMasterTabs
          value={value}
          onChange={handleChange}
          aria-label="basic tabs example"
          variant="fullWidth"
        >
          <Tab
            label="Manage data"
            icon={<ConnectWithoutContactIcon />}
            iconPosition="start"
            {...a11yProps(0)}
          />
          <Tab
            icon={<PendingActionsIcon />}
            iconPosition="start"
            label="My Requests"
            {...a11yProps(1)}
          />
        </DataPMasterTabs>
      </DataPTabContainer>
      <CustomTabPanel value={value} index={0}>
        <DataParametersTab1 />
      </CustomTabPanel>
      <CustomTabPanel value={value} index={1}>
        <DataParametersRequestTab2 />
      </CustomTabPanel>
    </>
  );
}



/// tab 1
import { useEffect, useState } from "react";
import {
  Box,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  IconButton,
  Button,
} from "@mui/material";
import AddIcon from "@mui/icons-material/Add";
import VisibilityIcon from "@mui/icons-material/Visibility";
import EditIcon from "@mui/icons-material/Edit";
import useApi from "../../hooks/useApi";
import useCustomSnackbar from "../../utils/useCustomSnackbar";
import DataParametersDialog from "./DataParametersDialog";
import { data } from "react-router-dom";

export default function ManageDataTab() {
  const { callApi } = useApi();
  const snackbar = useCustomSnackbar();

  const [rows, setRows] = useState([]);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [mode, setMode] = useState("CREATE");
  const [selectedData, setSelectedData] = useState(null);

  const normalizeRows = (rows) =>
    rows.map((r) => ({
      ...r,
      toBeIncluded:
        r.toBeIncluded === true ||
        r.toBeIncluded === "true" ||
        r.toBeIncluded === "YES",
      dataType: r.dataType?.toUpperCase(),
    }));

  const fetchData = async () => {
    try {
      const res = await callApi("/CM/common-master/data-parameters", {}, "GET");
      const res1 = await callApi(
        "/CM/common-master/files-sub-types",
        {},
        "GET",
      );
      console.log("res1", res1);
      const data = res?.data || [];
      console.log("data", data);
      if (!Array.isArray(data)) {
        const formatted = Object.keys(data || {}).map((key) => ({
          fileType: key,
          rows: normalizeRows(data[key]),
        }));
        setRows(formatted);
      } else {
        setRows(data);
      }
    } catch {
      snackbar("Failed to load data", "error");
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  return (
    <Box mt={2}>
      <Box display="flex" justifyContent="flex-end" mb={2}>
        <Button
          variant="contained"
          startIcon={<AddIcon />}
          onClick={() => {
            setMode("CREATE");
            setSelectedData(null);
            setDialogOpen(true);
          }}
        >
          Create
        </Button>
      </Box>

      <Table>
        <TableHead>
          <TableRow>
            <TableCell>File Type</TableCell>
            <TableCell align="right">Actions</TableCell>
          </TableRow>
        </TableHead>

        <TableBody>
          {rows.map((row) => (
            <TableRow key={row.fileType}>
              <TableCell>{row.fileType}</TableCell>
              <TableCell align="right">
                <IconButton
                  onClick={() => {
                    setMode("VIEW");
                    setSelectedData(row);
                    setDialogOpen(true);
                  }}
                >
                  <VisibilityIcon />
                </IconButton>

                <IconButton
                  onClick={() => {
                    setMode("EDIT");
                    setSelectedData(row);
                    setDialogOpen(true);
                  }}
                >
                  <EditIcon />
                </IconButton>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      <DataParametersDialog
        open={dialogOpen}
        mode={mode}
        data={selectedData}
        allData={rows}
        refresh={fetchData}
        onClose={() => setDialogOpen(false)}
      />
    </Box>
  );
}


/// dialog

import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  MenuItem,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  RadioGroup,
  FormControlLabel,
  Radio,
  IconButton,
} from "@mui/material";

import AddIcon from "@mui/icons-material/Add";
import DeleteIcon from "@mui/icons-material/Delete";

import { useForm, useFieldArray, Controller } from "react-hook-form";
import { useEffect, useState } from "react";

import useApi from "../../hooks/useApi";
import useCustomSnackbar from "../../utils/useCustomSnackbar";

export default function DataParametersDialog({
  open,
  mode,
  data,
  allData,
  onClose,
  refresh,
}) {
  const isView = mode === "VIEW";
  const isEdit = mode === "EDIT";
  const isCreate = mode === "CREATE";

  const { callApi } = useApi();
  const snackbar = useCustomSnackbar();
  const [subTypeRows, setSubTypeRows] = useState([]);
  const fetchData = async () => {
    try {
      const res1 = await callApi(
        "/CM/common-master/files-sub-types",
        {},
        "GET",
      );
      console.log("res1", res1?.data);
      const subtypedata = res1?.data || [];
      console.log("sunnnnn", subtypedata);
      setSubTypeRows(subtypedata);
    } catch {
      snackbar("Failed to load data", "error");
    }
  };
  useEffect(() => {
    fetchData();
  }, []);

  const { control, watch, setValue, getValues } = useForm({
    defaultValues: {
      fileType: "",
      rows: [],
    },
  });

  const { fields, append, remove, replace } = useFieldArray({
    control,
    name: "rows",
  });

  /* ---------------- MODE HANDLING ---------------- */

  useEffect(() => {
    if (isCreate) {
      setValue("fileType", "");
      replace([]);
    }

    if ((isEdit || isView) && data) {
      setValue("fileType", data.fileType);
      replace(data.rows || []);
    }
  }, [mode, data]);

  const selectedFileType = watch("fileType");

  useEffect(() => {
    if (!selectedFileType) {
      replace([]);
      return;
    }

    const selected = allData?.find(
      (item) => item.fileType === selectedFileType,
    );
   const fileTypeExists = allData?.some(
      (item) => item.fileType === selectedFileType
    );

    console.log("alldata", selected);
    if (selected) {
      replace(
        selected.rows.map((r) => ({
          ...r,
          toBeIncluded:
            r.toBeIncluded === true ||
            r.toBeIncluded === "true" ||
            r.toBeIncluded === "YES",
          dataType: r.dataType?.toUpperCase(),
        })),
      );
    } else {
      replace([]);
    }
  }, [selectedFileType]);

  // /* ---------------- ADD ROW WITH AUTO START ---------------- */

  // const handleAddRow = () => {
  //   const currentRows = getValues("rows");

  //   let nextStart = 1;

  //   if (currentRows.length > 0) {
  //     const lastRow = currentRows[currentRows.length - 1];
  //     nextStart = Number(lastRow.endValue || 0) + 1;
  //   }

  //   append({
  //     columnId: null,
  //     columnName: "",
  //     startValue: nextStart,
  //     endValue: "",
  //     toBeIncluded: true,
  //     dataType: "STRING",
  //     decimalCount: null,
  //   });
  // };

  /* ---------------- VALIDATION ---------------- */

  const validateForm = (formData) => {
    if (!formData.fileType) {
      snackbar("File Type is required", "error");
      return false;
    }

    if (formData.rows.length === 0) {
      snackbar("At least one row required", "error");
      return false;
    }

    for (let i = 0; i < formData.rows.length; i++) {
      const r = formData.rows[i];

      if (!r.columnName) {
        snackbar(`Column Name required (Row ${i + 1})`, "error");
        return false;
      }

      if (Number(r.startValue) >= Number(r.endValue)) {
        snackbar(`End must be greater than Start (Row ${i + 1})`, "error");
        return false;
      }

      if (
        r.dataType === "AMOUNT" &&
        (r.decimalCount === null || r.decimalCount === "")
      ) {
        snackbar(`Decimal required for AMOUNT (Row ${i + 1})`, "error");
        return false;
      }
    }

    return true;
  };

  /* ---------------- SUBMIT ---------------- */

  const onSubmit = async () => {
    const formData = getValues();
    if (!validateForm(formData)) return;

    const payload = {
      requestType: "MAIN_DATA_PARAMETERS",
      changeType: isEdit ? "UPDATE" : "ADD",
      payload: formData,
    };

    await callApi("/CR/create-request", payload, "POST");

    snackbar("Request submitted successfully", "success");
    refresh();
    onClose();
  };

  return (
    <Dialog open={open} fullWidth maxWidth="xl">
      <DialogTitle>{mode} Data Parameters</DialogTitle>

      <DialogContent>
        {/* FILE TYPE FIELD */}
        {/* 
        {isCreate ? (
          <Controller
            name="fileType"
            control={control}
            render={({ field }) => (
              <TextField
                {...field}
                label="File Type"
                fullWidth
                margin="normal"
              />
            )}
          />
        ) : ( */}
        <Controller
          name="fileType"
          control={control}
          render={({ field }) => (
            <TextField
              {...field}
              select
              label="File Type"
              fullWidth
              margin="normal"
              disabled={isView}
            >
              {subTypeRows?.map((item) => (
                <MenuItem key={item} value={item}>
                  {item}
                </MenuItem>
              ))}
              {/* <MenuItem key={fetchData} value={fetchData}>
                {fetchData}
              </MenuItem> */}
            </TextField>
          )}
        />
        {/* )}  */}

        {!isView && (
          <Button
            startIcon={<AddIcon />}
            onClick={() =>
              append({
                columnId: null,
                columnName: "",
                startValue: "",
                endValue: "",
                toBeIncluded: true,
                dataType: "STRING",
                decimalCount: null,
              })
            }
          >
            {/* onClick={handleAddRow}> */}
            Add Row
          </Button>
        )}

        {/* VIEW MODE TABLE */}
        <Table size="small">
          <TableHead>
            <TableRow>
              <TableCell>Column Id</TableCell>
              <TableCell>Column Name</TableCell>
              <TableCell>Start</TableCell>
              <TableCell>End</TableCell>
              <TableCell>Included</TableCell>
              <TableCell>Data Type</TableCell>
              <TableCell>Decimal</TableCell>
              {!isView && <TableCell />}
            </TableRow>
          </TableHead>

          <TableBody>
            {fields.map((row, index) => {
              const dataType = watch(`rows.${index}.dataType`);

              return (
                <TableRow key={row.id}>
                  <TableCell>{row.columnId || "-"}</TableCell>

                  <TableCell>
                    {isView ? (
                      row.columnName
                    ) : (
                      <Controller
                        name={`rows.${index}.columnName`}
                        control={control}
                        render={({ field }) => (
                          <TextField
                            {...field}
                            disabled={
                              mode === "CREATE" &&
                              fileTypeExists &&
                              row.columnId !== null
                            }
                          />
                        )}
                      />
                    )}
                  </TableCell>

                  <TableCell>
                    {isView ? (
                      row.startValue
                    ) : (
                      <Controller
                        name={`rows.${index}.startValue`}
                        control={control}
                        render={({ field }) => (
                          <TextField type="number" {...field} />
                        )}
                      />
                    )}
                  </TableCell>

                  <TableCell>
                    {isView ? (
                      row.endValue
                    ) : (
                      <Controller
                        name={`rows.${index}.endValue`}
                        control={control}
                        render={({ field }) => (
                          <TextField type="number" {...field} />
                        )}
                      />
                    )}
                  </TableCell>

                  <TableCell>
                    {isView ? (
                      row.toBeIncluded ? (
                        "YES"
                      ) : (
                        "NO"
                      )
                    ) : (
                      <Controller
                        name={`rows.${index}.toBeIncluded`}
                        control={control}
                        render={({ field }) => (
                          <RadioGroup
                            row
                            value={field.value ? "YES" : "NO"}
                            onChange={(e) =>
                              field.onChange(e.target.value === "YES")
                            }
                          >
                            <FormControlLabel
                              value="YES"
                              control={<Radio />}
                              label="Yes"
                            />
                            <FormControlLabel
                              value="NO"
                              control={<Radio />}
                              label="No"
                            />
                          </RadioGroup>
                        )}
                      />
                    )}
                  </TableCell>

                  <TableCell>
                    {isView ? (
                      row.dataType
                    ) : (
                      <Controller
                        name={`rows.${index}.dataType`}
                        control={control}
                        render={({ field }) => (
                          <TextField select {...field}>
                            <MenuItem value="STRING">STRING</MenuItem>
                            <MenuItem value="AMOUNT">AMOUNT</MenuItem>
                          </TextField>
                        )}
                      />
                    )}
                  </TableCell>

                  <TableCell>
                    {isView ? (
                      row.decimalCount
                    ) : (
                      <Controller
                        name={`rows.${index}.decimalCount`}
                        control={control}
                        render={({ field }) => (
                          <TextField
                            type="number"
                            {...field}
                            disabled={dataType !== "AMOUNT"}
                          />
                        )}
                      />
                    )}
                  </TableCell>

                  {!isView && (
                    <TableCell>
                      {!row.columnId && (
                        <IconButton onClick={() => remove(index)}>
                          <DeleteIcon />
                        </IconButton>
                      )}
                    </TableCell>
                  )}
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Cancel</Button>
        {!isView && (
          <Button onClick={onSubmit} variant="contained">
            Submit
          </Button>
        )}
      </DialogActions>
    </Dialog>
  );
}


// request

import {
  Box,
  Button,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  Stack,
  Typography,
  Tooltip,
  IconButton,
  Chip,
} from "@mui/material";
import { DataGrid } from "@mui/x-data-grid";
import { useEffect, useMemo, useState } from "react";
import VisibilityIcon from "@mui/icons-material/Visibility";
import PendingActionsIcon from "@mui/icons-material/PendingActions";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import BlockFlippedIcon from "@mui/icons-material/BlockFlipped";
import CancelIcon from "@mui/icons-material/Cancel";
import DateRangeIcon from "@mui/icons-material/DateRange";
import GppBadIcon from "@mui/icons-material/GppBad";
import AddBoxIcon from "@mui/icons-material/AddBox";
import AutoDeleteIcon from "@mui/icons-material/AutoDelete";
import EditDocumentIcon from "@mui/icons-material/EditDocument";

import useApi from "../../hooks/useApi";
import useCustomSnackbar from "../../utils/useCustomSnackbar";
import CustomChip from "../../utils/CustomChip";
import ViewMyRequestDialog from "../common/ViewMyRequestDialog";

function CustomNoRowsOverlay() {
  return (
    <Stack height="100%" alignItems="center" justifyContent="center">
      <InfoIcon sx={{ fontSize: 48, color: "text.secondary", mb: 2 }} />
      <Typography variant="h6">No Requests Found</Typography>
      <Typography>You have not created any requests.</Typography>
    </Stack>
  );
}

export default function DataParametersRequestsTab() {
  const { callApi } = useApi();
  const snackbar = useCustomSnackbar();

  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [confirmDialog, setConfirmDialog] = useState(false);
  const [requestId, setRequestId] = useState(null);
  const [viewOpen, setViewOpen] = useState(false);
  const [viewData, setViewData] = useState(null);

  // ================= FETCH =================

  const fetchData = async () => {
    try {
      setLoading(true);

      const payload = { requestType: "MAIN_DATA_PARAMETERS" };

      const response = await callApi("/CR/my-requests", payload, "POST");

      if (response?.data) {
        const result = response.data.map((row) => {
          const parsedPayload = {
            ...row.payload,
            id: row.id,
            reqStatus: row.reqStatus,
            reqDate: row.reqDate,
            changeType: row.changeType,
          };

          return parsedPayload;
        });

        // Pending first, then latest date
        result.sort((a, b) => {
          if (a.reqStatus === "PENDING" && b.reqStatus !== "PENDING") return -1;
          if (a.reqStatus !== "PENDING" && b.reqStatus === "PENDING") return 1;
          return new Date(b.reqDate) - new Date(a.reqDate);
        });

        setRows(result);
      } else {
        setRows([]);
      }
    } catch (error) {
      snackbar("Failed to fetch requests", "error");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // ================= CANCEL =================

  const handleCancelRequest = async () => {
    try {
      const payload = {
        requestId,
        remarks: "User cancelled this request",
      };

      const response = await callApi("/CR/cancel-request", payload, "PATCH");

      if (response?.success) {
        snackbar(`Request ${requestId} cancelled successfully`, "success");
      } else {
        snackbar(response?.message || "Cancel failed", "error");
      }
    } catch (error) {
      snackbar("Cancel failed", "error");
    } finally {
      setConfirmDialog(false);
      fetchData();
    }
  };

  // ================= VIEW =================

  const handleViewClick = (row) => {
    const showData = {
       fileType: row.fileType,
    };

    row.showData = showData;
    setViewData(row);
    setViewOpen(true);
  };

  // ================= COLUMNS =================

  const columns = useMemo(
    () => [
      { field: "fileType", headerName: "File Type", flex: 1.5 },
      { field: "id", headerName: "Request Id", flex: 0.7 },

      {
        field: "changeType",
        headerName: "Request Type",
        flex: 1,
        align: "center",
        renderCell: (params) => {
          const val = params.value;

          const icon =
            val === "ADD" ? (
              <AddBoxIcon />
            ) : val === "DELETE" ? (
              <AutoDeleteIcon />
            ) : (
              <EditDocumentIcon />
            );

          const label =
            val === "ADD" ? "Added" : val === "DELETE" ? "Deleted" : "Modified";

          return <CustomChip variant="outlined" icon={icon} label={label} />;
        },
      },

      // Date
      {
        field: "reqDate",
        headerName: "Submitted On",
        flex: 1,
        renderCell: (params) => (
          <Chip icon={<DateRangeIcon />} label={params.value?.split("T")[0]} />
        ),
      },

      // Status
      {
        field: "reqStatus",
        headerName: "Status",
        flex: 1,
        align: "center",
        renderCell: (params) => {
          const val = params.value;

          const icon =
            val === "REJECTED" ? (
              <BlockFlippedIcon />
            ) : val === "ACCEPTED" ? (
              <CheckCircleIcon />
            ) : val === "CANCELLED" ? (
              <GppBadIcon />
            ) : (
              <PendingActionsIcon />
            );

          const label =
            val === "REJECTED"
              ? "Rejected"
              : val === "ACCEPTED"
                ? "Approved"
                : val === "CANCELLED"
                  ? "Cancelled"
                  : "Pending";

          return <CustomChip variant="outlined" icon={icon} label={label} />;
        },
      },

      // Actions
      {
        field: "actions",
        headerName: "Action",
        flex: 1,
        align: "center",
        renderCell: (params) => (
          <Stack direction="row" spacing={1}>
            <Tooltip title="View">
              <IconButton onClick={() => handleViewClick(params.row)}>
                <VisibilityIcon />
              </IconButton>
            </Tooltip>

            {params.row.reqStatus === "PENDING" && (
              <Tooltip title="Cancel">
                <IconButton
                  onClick={() => {
                    setRequestId(params.row.id);
                    setConfirmDialog(true);
                  }}
                >
                  <CancelIcon />
                </IconButton>
              </Tooltip>
            )}
          </Stack>
        ),
      },
    ],
    [],
  );

  return (
    <>
      <Box>
        <Box>
          <DataGrid
            rows={rows}
            columns={columns}
            loading={loading}
            // getRowId={(row) => row.id}
            pageSizeOptions={[5, 10, 25, 50]}
            initialState={{
              pagination: { paginationModel: { pageSize: 10, page: 0 } },
              // sorting: { sortModel: [{ field: "circleCode", sort: "asc" }] },
            }}
            slots={{
              noRowsOverlay: CustomNoRowsOverlay,
            }}
            getRowId={(row) => row.id}
          />
        </Box>
      </Box>
      {/* View Dialog */}
      <ViewMyRequestDialog
        open={viewOpen}
        handleClose={() => setViewOpen(false)}
        data={viewData}
      />

      {/* Cancel Dialog */}
      <Dialog open={confirmDialog} maxWidth="sm" fullWidth>
        <DialogTitle>Cancel Request ID: {requestId}</DialogTitle>
        <DialogContent>
          <Typography>Are you sure you want to cancel this request?</Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setConfirmDialog(false)}>Close</Button>
          <Button
            variant="contained"
            color="error"
            onClick={handleCancelRequest}
          >
            Confirm
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
}
//style

import * as React from "react";
import Tabs from "@mui/material/Tabs";
import Box from "@mui/material/Box";
import { styled } from "@mui/material/styles";
import { DataGrid } from "@mui/x-data-grid";
import { Chip, Fab, Grid, Stack, DialogTitle } from "@mui/material";
import AddIcon from "@mui/icons-material/Add";


export const DataPMastermainBox = styled(Box)(({ theme }) => ({
  py: 2,
}));
export const DataPTabContainer = styled(Box)(({ theme }) => ({
  borderBottom: 1,
  borderColor: "divider",
}));


export const DataPMasterTabs = styled(Tabs)(({ theme }) => ({
  width: "100%",
}));

export const DataPaamerer1Fab = styled(Fab)(({ theme }) => ({
  position: "fixed",
  borderRadius: 1,
  fontSize: "15px",
  bottom: theme.spacing(8),
  right: theme.spacing(4),
  zIndex: 1200,
}));

export const DataPaamererAddicon = styled(AddIcon)(({ theme }) => ({
  mr: 1,
}));
export const DataPtab1DialogTitle = styled(DialogTitle)(({ theme }) => ({
  m: 0,
  p: 2,
}));
