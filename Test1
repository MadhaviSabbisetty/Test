getOptionLabel={(o) => o?.zoneDesc || ""}  
          isOptionEqualToValue={(o, v) => o.zoneCode === v.zoneCode}  
          onChange={(e, v) => {  
            setZone(v);  
          }}  
          renderInput={(params) => (  
            <TextField {...params} label="Select a Zone" />  
          )}  
        />  

      <Autocomplete  
        sx={{width:380,  
          "& .MuiAutocomplete-endAdronment":{right:12},  
          "& .MuiAutocomplete-clearIndicator":{marginRight:"6px"},  
        }}  
        value={circle}  
        options={circleList}  
        loading={circleLoading}  
        disabled={!zone || circleLoading}  
        getOptionLabel={(o) => `${o.circleCode}-${o.circleName}`}  
        isOptionEqualToValue={(o, v) => o.circleCode === v.circleCode}  
        onChange={(e, v) => {  
          setCircle(v);  
        }}  
        renderInput={(params) => (  
          <TextField {...params} label="Select a Circle"   
          InputProps={{  
            ...params.InputProps,  
            endAdornment:(  
              <>  
              {circleLoading && <CircularProgress  size={20}/>}  
              {params.InputProps.endAdornment}  
              </>  
            ),  
          }}/>  
        )}  
      />  

    <Autocomplete  
      sx={{width:380,  
          "& .MuiAutocomplete-endAdronment":{right:12},  
          "& .MuiAutocomplete-clearIndicator":{marginRight:"6px"},  
         }}  
      value={branch}  
      options={Array.isArray(branchList)? branchList:[]}  
      loading={branchLoading}  
      disabled={!circle || branchLoading}  
      ListboxComponent={branchListBox}  
      open={branchOpen}  
      onOpen={()=> setBranchOpen(true)}  
      onClose={(e,reason)=>{  
        //if(reason==="blur")return;  
        if(skipNextCloseRef.current && reason==="blur"){  
          skipNextCloseRef.current=false;  
          return;  
        }  
        skipNextCloseRef.current=false;  
        setBranchOpen(false);  
      }}  
      //disableCloseOnSelect  
      disableListWrap  
      getOptionLabel={(o) =>  
        o?.branchCode ? `${o.branchCode} - ${o.branchName}` : ""  
      }  
      isOptionEqualToValue={(o, v) =>  
        o?.branchCode === v?.branchCode  
      }  
      onChange={(e, v) => {  
        setBranch(v);  
        setBranchOpen(false);  
      }}  
      renderInput={(params) => (  
        <TextField  
          {...params}  
          label="Select Branch"  
          InputProps={{  
            ...params.InputProps,  
            endAdornment: (  
              <>  
                {branchLoading && <CircularProgress size={18} />}  
                {params.InputProps.endAdornment}  
              </>  
            ),  
          }}  
        />  
      )}  
    />  
     </Box>  
      </Box>  

    <Box sx={styles.inputOuterBox}>  
      <Box sx={styles.inputInnerBox}>  

      {branch && (  
        <>  
          <Autocomplete  
            sx={{width:480,  
          "& .MuiAutocomplete-endAdronment":{right:12},  
          "& .MuiAutocomplete-clearIndicator":{marginRight:"6px"},  
         }}  
            value={selectedReport}  
            options={reportList}  
            loading={reportLoading}  
            disabled={reportLoading}  
            getOptionLabel={(o) => o?.reportName || ""}  
            isOptionEqualToValue={(o, v) => o.id === v.id}  
            onChange={(e, v) => setReport(v)}  
            renderInput={(params) => (  
              <TextField {...params} label="Select a report"   
              InputProps={{  
            ...params.InputProps,  
            endAdornment:(  
              <>  
              {reportLoading && <CircularProgress  size={20}/>}  
              {params.InputProps.endAdornment}  
              </>  
            ),  
          }}/>  
            )}  
          />  

          <LocalizationProvider dateAdapter={AdapterDayjs}>  
            <DatePicker  
              sx={{width:480}}  
              label="Select report date"  
              format="DD/MM/YYYY"  
              minDate={minDate}  
              maxDate={dayjs().endOf("day")}  
              value={selectedDate}  
              onChange={(v)=>setReportDate(v)}  
              onError={(err)=>setDateError(err)}  
              slotProps={{  
                textField:{  
                  error:!!dateError,  
                  helperText:dateError  
                  ?getErrorMessage(dateError)  
                  :"",  
                },  
              }}  
            />  
          </LocalizationProvider>  
        </>  
      )}  
       </Box>  
          </Box>  


      <Box sx={{...styles.buttonContainer,mt:-2}}>  
            <Button  
              sx={styles.downloadButton}  
              endIcon={<CloudDownloadTwoTone />}  
              variant="contained"  
              onClick={handleFetchReportData}  
              disabled={  
                disableInputs ||  
                !selectedReport ||  
                !selectedDate ||  
                !!dateError  
              }  
            >  
              {isDownloading ? "Downloading..." : "Fetch & Download"}  
            </Button>  

            <Fade in={isDownloading} unmountOnExit>  
              <Box sx={styles.progressContainer}>  
                <Box sx={styles.progressHeader}>  
                  <Box sx={styles.progressIconWrapper}>  
                    <CloudDownloadTwoTone sx={styles.innerDownloadIcon} />  
                  </Box>  
                  <Box sx={styles.progressHeaderTextBox}>  
                    <Typography variant="body2" fontWeight={600}>  
                      Searching{" "}  
                      {selectedReport?.reportName ?? "the selected report"}{" "}  
                      for the period{" "}  
                      {selectedDate?.isValid()  
                        ? selectedDate.format("YYYY-MM-DD")  
                        : "an unknown period"}{" "}  
                      is in progress.  
                    </Typography>  

                    <Typography  
                      variant="caption"  
                      color="text.secondary"  
                      sx={styles.progressCaption}  
                    >  
                      {downloadedMB  
                        ? `Streaming report data… ${downloadedMB} MB received`  
                        : "Preparing your report stream…"}  
                    </Typography>  
                  </Box>  

                  {downloadedMB && (  
                    <CustomChip  
                      color="error"  
                      label={`${downloadedMB} MB downloaded`}  
                      variant="filled"  
                    />  
                  )}  
                </Box>  
                <LinearProgress  
                  variant="indeterminate"  
                  sx={styles.progressBar}  
                />  
              </Box>  
            </Fade>  
          </Box>  
        </Card>  
      </Stack>  
    </Box>  
  </Stack>  
</Grow>

);
}
