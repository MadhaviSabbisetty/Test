import React, { useEffect, useState, forwardRef } from "react";
import {
  Box,
  Card,
  Stack,
  Typography,
  TextField,
  Button,
  Grow,
  CircularProgress,
  LinearProgress,
  Fade,
} from "@mui/material";

import AccountBalanceOutlinedIcon from "@mui/icons-material/AccountBalance";
import Autocomplete from "@mui/material/Autocomplete";
import { LocalizationProvider, DatePicker } from "@mui/x-date-pickers";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import dayjs from "dayjs";

import { useSelector } from "react-redux";
import { useTheme } from "@mui/material/styles";

import useApi from "../../hooks/useApi";
import useCustomSnackbar from "../../utils/useCustomSnackbar";
import GlifReportsStyles from "./GlifReportsStyles";

import {
  Summarize,
  CloudDownloadTwoTone,
  LooksOne,
  LooksTwo,
  Looks3,
  Looks4,
  Looks5,
} from "@mui/icons-material";
import CustomChip from "../../utils/CustomChip";

const moduleType = "BRANCH_WISE";

export default function BranchWiseReports() {
  const user = useSelector((state) => state.auth.user);
  const { callApi } = useApi();
  const showSnackBar = useCustomSnackbar();
  const theme = useTheme();
  const styles = GlifReportsStyles(theme);

  /* ---------------- STATES ---------------- */
  const [countryType, setCountryType] = useState("INDIAN");

  const [zoneList, setZoneList] = useState([]);
  const [circleList, setCircleList] = useState([]);
  const [branchList, setBranchList] = useState([]);
  const [reportList, setReportList] = useState([]);

  const [zone, setZone] = useState(null);
  const [circle, setCircle] = useState(null);
  const [branch, setBranch] = useState(null);
  const [selectedReport, setReport] = useState(null);
  const [selectedDate, setReportDate] = useState(null);

  const [circleLoading, setCircleLoading] = useState(false);
  const [branchLoading, setBranchLoading] = useState(false);
  const [reportLoading, setReportLoading] = useState(false);

  const [branchSize, setBranchSize] = useState(20);
  const [branchHasMore, setBranchHasMore] = useState(true);

  const [isDownloading, setIsDownloading] = useState(false);
  const [downloadedBytes, setDownloadedBytes] = useState(0);

  const [minDate, setMinDate] = useState(dayjs("2020-01-01"));
  const [dateError, setDateError] = useState(null);

  const downloadedMB =
    downloadedBytes > 0
      ? (downloadedBytes / (1024 * 1024)).toFixed(2)
      : null;

  /* ---------------- INITIAL LOAD ---------------- */
  useEffect(() => {
    fetchZones();
  }, []);

  /* ---------------- API CALLS ---------------- */

  const fetchZones = async () => {
    try {
      const res = await callApi("/CM/common-master/indian-zones", {}, "GET");
      setZoneList(res?.data || []);
    } catch {
      setZoneList([]);
    }
  };

  useEffect(() => {
    if (!zone?.zoneCode) return;
    setCircle(null);
    setBranch(null);
    setCircleList([]);
    setBranchList([]);
    fetchCircles(zone);
  }, [zone, countryType]);

  const fetchCircles = async (zone) => {
    try {
      setCircleLoading(true);
      const bankType = countryType === "FOREIGN" ? "Foreign" : "Indian";
      const res = await callApi(
        `/CM/common-master/indian-foreign-circles?bankType=${bankType}&zoneCode=${zone.zoneCode}`,
        null,
        "GET"
      );
      setCircleList(res?.data || []);
    } finally {
      setCircleLoading(false);
    }
  };

  useEffect(() => {
    if (!circle?.circleCode) return;
    setBranch(null);
    setBranchList([]);
    setBranchSize(20);
    setBranchHasMore(true);
    fetchBranches(circle, 20);
  }, [circle]);

  const fetchBranches = async (circle, size) => {
    if (!circle || branchLoading || !branchHasMore) return;
    try {
      setBranchLoading(true);
      const res = await callApi(
        `/CM/common-master/indian-foreign-branches?circleCode=${circle.circleCode}&size=${size}`,
        null,
        "GET"
      );
      const branches = res?.data?.data || res?.data || [];
      setBranchList(branches);
      setBranchHasMore(branches.length === size);
      setBranchSize(size);
    } finally {
      setBranchLoading(false);
    }
  };

  useEffect(() => {
    if (!branch?.branchCode) return;
    fetchReports(branch);
  }, [branch]);

  const fetchReports = async (branch) => {
    try {
      setReportLoading(true);
      const res = await callApi(
        "/RS/reports/types",
        {
          moduleType,
          countryType,
          zoneId: zone?.zoneCode,
          circleCode: circle?.circleCode,
          branchCode: branch?.branchCode,
          roleId: user.role,
        },
        "POST"
      );
      setReportList(res?.data || []);
    } finally {
      setReportLoading(false);
    }
  };

  /* ---------------- BRANCH LISTBOX (INFINITE SCROLL) ---------------- */

  const BranchListBox = forwardRef(function BranchListBox(props, ref) {
    const { children, ...other } = props;

    return (
      <ul
        ref={ref}
        {...other}
        onScroll={(e) => {
          const list = e.currentTarget;
          if (
            list.scrollTop + list.clientHeight >=
              list.scrollHeight - 10 &&
            branchHasMore &&
            !branchLoading
          ) {
            fetchBranches(circle, branchSize + 20);
          }
        }}
      >
        {children}
        {branchLoading && (
          <li style={{ textAlign: "center", padding: 8 }}>
            <CircularProgress size={18} />
          </li>
        )}
      </ul>
    );
  });

  /* ---------------- UI ---------------- */

  return (
    <Grow in timeout={500}>
      <Card sx={{ ...styles.card, width: 1550, mx: "auto", p: 3 }}>
        <Autocomplete
          sx={{ width: 380 }}
          value={zone}
          options={zoneList}
          getOptionLabel={(o) => o?.zoneDesc || ""}
          onChange={(e, v) => setZone(v)}
          renderInput={(params) => (
            <TextField {...params} label="Select Zone" />
          )}
        />

        <Autocomplete
          sx={{ width: 380, mt: 2 }}
          value={circle}
          options={circleList}
          loading={circleLoading}
          disabled={!zone}
          getOptionLabel={(o) => `${o.circleCode}-${o.circleName}`}
          onChange={(e, v) => setCircle(v)}
          renderInput={(params) => (
            <TextField
              {...params}
              label="Select Circle"
              InputProps={{
                ...params.InputProps,
                endAdornment: (
                  <>
                    {circleLoading && <CircularProgress size={18} />}
                    {params.InputProps.endAdornment}
                  </>
                ),
              }}
            />
          )}
        />

        <Autocomplete
          sx={{ width: 380, mt: 2 }}
          value={branch}
          options={branchList}
          loading={branchLoading}
          disabled={!circle}
          ListboxComponent={BranchListBox}
          getOptionLabel={(o) =>
            o?.branchCode ? `${o.branchCode} - ${o.branchName}` : ""
          }
          onChange={(e, v) => setBranch(v)}
          renderInput={(params) => (
            <TextField
              {...params}
              label="Select Branch"
              InputProps={{
                ...params.InputProps,
                endAdornment: (
                  <>
                    {branchLoading && <CircularProgress size={18} />}
                    {params.InputProps.endAdornment}
                  </>
                ),
              }}
            />
          )}
        />
      </Card>
    </Grow>
  );
}
